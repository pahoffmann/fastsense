\documentclass{beamer}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{amsmath}
\usepackage{tikz}
\usetikzlibrary{snakes}
\usepackage{xcolor} % Farben
\usepackage{fancyvrb} % Code
\usepackage[absolute,overlay]{textpos} % Bilder irgendwohin
\usepackage{bm} % Fett in Mathemodus
\usepackage{siunitx} % Einheiten
\usepackage{multicol} % Equations nebeneinander
\usepackage{algorithm2e} % Algorithmen
\usepackage{array} % Tabellenspalten zentriert
\usepackage{hyperref} % Links
\usepackage{ngerman}[babel]
\usepackage[style=numeric]{biblatex}
\addbibresource{bib.bib}

\setbeamertemplate{bibliography item}{\insertbiblabel}
\setbeamercolor{bibliography entry note}{fg=black}

\usecolortheme{seahorse}
\definecolor{dark}{rgb}{0, 0.1, 0.3}
\definecolor{light}{rgb}{0.9, 0.933, 1}
\setbeamercolor{normal text}{fg=black}
\setbeamercolor{structure}{fg=dark}
\setbeamercolor{footline}{fg=black}
\setbeamercolor{frametitle}{fg=light,bg=dark}
\setbeamertemplate{itemize items}[circle]
\beamertemplatenavigationsymbolsempty
\addtobeamertemplate{navigation symbols}{}{
    \usebeamerfont{footline}
    \usebeamercolor[fg]{footline}
    {\footnotesize \insertframenumber\\\vspace{0.15cm}}
}
\setbeamertemplate{title page}{
    \begin{center}
    Projektgruppe FastSense\\\vspace{1cm}
    \begin{LARGE}
    Meilenstein 2\\\vspace{0.5cm}   
    Hardware Accelerated TSDF SLAM
    \end{LARGE}\\\vspace{1cm}
    28. Oktober 2020
    \end{center}
}

\begin{document}

{\setbeamertemplate{navigation symbols}{}
%\usebackgroundtemplate{\includegraphics[width=\paperwidth]{images/tsdf_map.png}}
\begin{frame}
\titlepage
\end{frame}}

\begin{frame}
\frametitle{Inhalt}
\tableofcontents
\end{frame}



\section{Ziele und Anforderungen}
\begin{frame}{}
\begin{center}
\begin{tikzpicture}
\fill[light] (0, 0) rectangle (8, 2);
\node[dark] at (4, 1) {\begin{LARGE}\secname\end{LARGE}};
\end{tikzpicture}
\end{center}
\end{frame}

\subsection{Ziele für MS2}
\begin{frame}{\subsecname}
\begin{itemize}
\item Implementation von inkrementellem TSDF SLAM in \glqq{}autarker\grqq{} Box
\item Vorimplementation in Software
\item Implementation einzelner Komponenten in Hardware
\item Speicherung von Pose-Graph und TSDF-Karte zur Rekonstruktion des kompletten explorierten Bereichs
\item Evaluation durch Zeit- und Strommessung
\end{itemize}
\end{frame}

\subsection{Funktionale Anforderungen}
\begin{frame}{\subsecname}
\begin{itemize}
\item{Lokale TSDF-Map ausgeben}
\item{Aktuelle 6D-Pose ausgeben}
\item{Map auf Basis der IMU und Velodyne-Daten}
\item{Trajektorie und TDSF-Map für jede Pose speichern}
\item{Parameter zur Laufzeit anpassbar}
\end{itemize}
\begin{center}
\begin{tikzpicture}
\draw [fill=light] (-1, -1) rectangle +(2, 2);
\draw [->] (-3, 0.5) node [left] {Laserscan} -- (-1, 0.5);
\draw [->] (-3, -0.5) node [left] {IMU} -- (-1, -0.5);
\draw [->] (1, 0.5) -- (3, 0.5) node [right] {Lokale Map};
\draw [->] (1, -0.5) -- (3, -0.5) node [right] {Aktuelle Pose};
\draw [->] (-0.5, -1) -- (-0.5, -2) node [below left] {Globale Map};
\draw [->] (0.5, -1) -- (0.5, -2) node [below right] {Posen};
\end{tikzpicture}
\end{center}
\end{frame}

\subsection{Nicht-Funktionale Anforderungen}
\begin{frame}{\subsecname}
\begin{itemize}
\item{HW-Plattform: Trenz-Board}
\item{Entwicklungsplattform: Vitis}
\item{Beschleunigung der Algorithmen durch FPGA}
\item{Sensoren direkt am Board}
\item{Unit-Tests}
\item{Testbench}
\begin{itemize}
\item{Integration, Strommessung, Zeitmessung, Visualisierung}
\end{itemize}
\item{Logging}
\end{itemize}
\end{frame}



\section{Implementierung}
\begin{frame}{}
\begin{center}
\begin{tikzpicture}
\fill[light] (0, 0) rectangle (8, 2);
\node[dark] at (4, 1) {\begin{LARGE}\secname\end{LARGE}};
\end{tikzpicture}
\end{center}
\end{frame}

\subsection{Recap: Prototyping Demo}
\begin{frame}{\subsecname}
\begin{itemize}
\item Gute Parameterkombination herausgefunden
\item Geplante Funktionalität war vorhanden und in RViz darstellbar
\item Erkannte Probleme / Bottlenecks:
\begin{itemize}
\item Laufzeit stark abhängig von der Auflösung der Karte
\item Probleme mit Orientierung (kurz nach Demo gefixt)
\item Insgesamt noch recht langsam ($\sim$0.5s/Scan auf Glumanda, 2-5s/Scan in Testwelt)
\item Registrierung und TSDF-Update als parallelisierbare Bottlenecks
\end{itemize}
\end{itemize}
\begin{figure}
\minipage{0.49\textwidth}
    \includegraphics[width=\linewidth]{images/demo1.jpg}
\endminipage\hfill
\minipage{0.49\textwidth}
    \includegraphics[width=\linewidth]{images/demo2.jpg}
\endminipage\hfill
\end{figure}
\end{frame}

\subsection{Algorithmus}
\begin{frame}{\subsecname}
\begin{center}
\begin{tikzpicture}
\draw (0, 4) rectangle +(4, 1);
\node at (2, 4.5) {Registrierung};
\draw [->] (2, 4) -- (2, 3);
\draw (0, 2) rectangle +(4, 1);
\node at (2, 2.5) {Map Shift};
\draw [->] (2, 2) -- (2, 1);
\draw (0, 0) rectangle +(4, 1);
\node at (2, 0.5) {TSDF Update};
\draw (0, 0.5) -- (-3, 0.5) -- (-3, 1);
\draw [->, dashed] (-3, 1) -- (-3, 2);
\draw (-5.5, 2) rectangle +(5, 1);
\node at (-3, 2.5) {Empfange nächsten Scan};
\draw [dashed] (-3, 3) -- (-3, 4);
\draw [->] (-3, 4) -- (-3, 4.5) -- (0, 4.5);
\draw (-3, -1) ellipse (1cm and 0.5cm) node{Start};
\draw [->] (-2, -1) -- (2, -1) -- (2, 0);
\end{tikzpicture}
\end{center}
\end{frame}

\begin{frame}{\subsecname}
\begin{center}
\begin{tikzpicture}
\draw [fill=light] (0, 4) rectangle +(3, 1);
\node at (1.5, 4.5) {Registrierung};
\draw [->] (1.5, 4) -- (1.5, 3);
\draw (0, 2) rectangle +(3, 1);
\node at (1.5, 2.5) {Map Shift};
\draw [->] (1.5, 2) -- (1.5, 1);
\draw (0, 0) rectangle +(3, 1);
\node at (1.5, 0.5) {TSDF Update};
\draw (3, 5) -- (4, 6.5);
\draw (3, 4) -- (4, -1.5);
\node [right] at (4, 2.5) {\begin{minipage}{6.5cm}
\begin{algorithm}[H]
\SetKwRepeat{Do}{do}{while}
$T$ = Initial Transform\;
\vspace{0.2cm}
Transform point cloud with $T$\;
\vspace{0.2cm}
\Do{under max iterations and $E$ not converged}{
    \vspace{0.2cm}
    $E$ = Minimization of the sum of signed distances squared\;
    \vspace{0.2cm}
    Transform point cloud with $T(E)$\;
    \vspace{0.2cm}
}
\vspace{0.2cm}
\Return $T$\;
\end{algorithm}
\end{minipage}};
\end{tikzpicture}
\end{center}
\end{frame}

\begin{frame}{\subsecname}
\begin{center}
\begin{tikzpicture}
\draw (0, 4) rectangle +(3, 1);
\node at (1.5, 4.5) {Registrierung};
\draw [->] (1.5, 4) -- (1.5, 3);
\draw [fill=light] (0, 2) rectangle +(3, 1);
\node at (1.5, 2.5) {Map Shift};
\draw [->] (1.5, 2) -- (1.5, 1);
\draw (0, 0) rectangle +(3, 1);
\node at (1.5, 0.5) {TSDF Update};
\draw (3, 3) -- (4, 6.5);
\draw (3, 2) -- (4, -1.5);
\node [right] at (4, 2.5) {\begin{minipage}{6.5cm}
\begin{itemize}
\item{LocalMap (aka RingBuffer)}
\begin{itemize}
\item{Geteilt zwischen SW und HW}
\end{itemize}
\end{itemize}
\definecolor{cyan}{rgb}{0, 1, 1}
\begin{tabular}{ccc}
\begin{tikzpicture}[scale=0.125]
\node at (-1.1, 8) {\includegraphics[width=2cm]{images/mario.png}};
\draw (0, 0) grid (16, 16);
\draw[ultra thick, cyan] (9, 9) rectangle +(5, 5);
\end{tikzpicture}
\hspace{-0.5cm}
&
\begin{tikzpicture}[scale=0.125]
\node at (-1.1, 8) {\includegraphics[width=2cm]{images/mario.png}};
\draw (0, 0) grid (16, 16);
\draw[thick, cyan, dashed] (9, 9) rectangle +(5, 5);
\draw[ultra thick, cyan] (9, 6) rectangle +(5, 5);
\end{tikzpicture}
\hspace{-0.5cm}
&
\begin{tikzpicture}[scale=0.125]
\node at (-1.1, 8) {\includegraphics[width=2cm]{images/mario.png}};
\draw (0, 0) grid (16, 16);
\draw[thick, cyan, dashed] (9, 9) rectangle +(5, 5);
\draw[thick, cyan, dashed] (9, 6) rectangle +(5, 5);
\draw[ultra thick, cyan] (6, 6) rectangle +(5, 5);
\end{tikzpicture}
\hspace{-0.5cm}
\\
\begin{tikzpicture}[scale=0.125]
\node at (-1.1, 2.5) {\includegraphics[width=0.625cm]{images/a.png}};
\draw (0, 0) grid (5, 5);
\end{tikzpicture}
\hspace{-0.5cm}
&
\begin{tikzpicture}[scale=0.125]
\node at (-1.1, 2.5) {\includegraphics[width=0.625cm]{images/c.png}};
\draw (0, 0) grid (5, 5);
\draw[ultra thick, cyan] (0, 2) -- (5, 2);
\draw[ultra thick, cyan] (2, 0) -- (2, 5);
\end{tikzpicture}
\hspace{-0.5cm}
&
\begin{tikzpicture}[scale=0.125]
\node at (-1.1, 2.5) {\includegraphics[width=0.625cm]{images/b.png}};
\draw (0, 0) grid (5, 5);
\draw[ultra thick, cyan] (0, 2) -- (5, 2);
\end{tikzpicture}
\hspace{-0.5cm}
\\
\end{tabular}
\begin{itemize}
\item{Werte außerhalb in GlobalMap}
\begin{itemize}
\item{Chunk-basiert}
\end{itemize}
\item{Speicherung in HDF5}
\end{itemize}
\end{minipage}};
\end{tikzpicture}
\end{center}
\end{frame}

\begin{frame}{\subsecname}
\begin{center}
\begin{tikzpicture}
\draw (0, 4) rectangle +(3, 1);
\node at (1.5, 4.5) {Registrierung};
\draw [->] (1.5, 4) -- (1.5, 3);
\draw (0, 2) rectangle +(3, 1);
\node at (1.5, 2.5) {Map Shift};
\draw [->] (1.5, 2) -- (1.5, 1);
\draw [fill=light] (0, 0) rectangle +(3, 1);
\node at (1.5, 0.5) {TSDF Update};
\draw (3, 1) -- (4, 6.5);
\draw (3, 0) -- (4, -1.5);
\node [right] at (4, 2.5) {\begin{minipage}{6.5cm}
\begin{itemize}
\item[1.]{TSDF Generierung\\
\mbox{\includegraphics[height=2.8cm]{images/tsdf_calc.png}\hspace{0.1cm}\includegraphics[height=2.8cm]{images/tsdf_map.png}}\\
\begin{footnotesize}\hspace{1.75cm}\cite{sdf_tracker}\end{footnotesize}}
\item[2.]{Update mit gewichtetem Mittelwert
\begin{align*}
M_V &= \frac{M_V \cdot M_W + v \cdot w}{M_W + w} \\
M_W &= \min(M_W + w, W_{\text{max}})
\end{align*}}

\end{itemize}
\end{minipage}};
\end{tikzpicture}
\end{center}
\end{frame}

\subsection{Hardware Implementierung}
\begin{frame}{\subsecname}
\begin{center}
\begin{LARGE}
Registrierung
\end{LARGE}
\end{center}
\begin{itemize}
\item{Parallelisierbare Schritte der Schleife in HW\\(Berechnungen für alle Punkte)}
\item{Matrixinvertierung in der Schleife bleibt in SW}
\end{itemize}
\vspace{1cm}
\begin{center}
\begin{LARGE}
TSDF Update
\end{LARGE}
\end{center}
\begin{itemize}
\item{Vollständig in HW}
\item{Bresenham Algorithmus für die Iteration über Punkte entlang eines Strahls}
\item{Synchronisation angepasst}
\end{itemize}
\end{frame}

\subsection{FastSense Prototyp}
\begin{frame}{\subsecname}
\begin{center}
\begin{tikzpicture}
\draw (0, 0) rectangle (6, 3);
\draw (1, 3) -- (2, 5) -- (4, 5) -- (5, 3);
\draw [fill=light] (2, 0.75) rectangle +(2, 1);
\node at (3, 1.25) {Trenz};
\draw [fill=light] (2, 3) rectangle +(2, 0.5);
\node at (3, 3.25) {Router};
\draw [fill=light] (2.5, 5) rectangle +(1, 1);
\node [above] at (3, 6) {Velodyne};
\draw [fill=light] (3.5, 5) rectangle +(0.5, 0.5);
\node [right] at (4, 5.25) {IMU};
\end{tikzpicture}
\end{center}
\end{frame}

\begin{frame}{\subsecname}
\begin{center}
\begin{tabular}{cc}
\begin{tikzpicture}[scale=0.5]
\draw (0, 0) rectangle (6, 3);
\draw (1, 3) -- (2, 5) -- (4, 5) -- (5, 3);
\draw [fill=light] (2, 0.75) rectangle +(2, 1);
\node at (3, 1.25) {Trenz};
\draw [fill=light] (2, 3) rectangle +(2, 0.5);
\node [above] at (3, 3.5) {Router};
\draw [fill=light] (2.5, 5) rectangle +(1, 1);
\node [above] at (3, 6) {Velodyne};
\draw (0, 0) -- (0, -6) -- (6, -6) -- (6, 0);
\draw [fill=light] (3.5, 5) rectangle +(0.5, 0.5);
\node [right] at (4, 5.25) {IMU};
\draw (0, -4) -- (6, -4);
\draw [fill=light] (2, -4) rectangle +(2, 0.5);
\node [above] at (3, -3.5) {NUC};
%\draw [fill=light] (2.5, -6) rectangle +(1, 0.5);
%\node [above] at (3, -5.5) {IMU};
\draw [fill=white] (1.25, -6) circle (1);
\draw [fill=white] (4.75, -6) circle (1);
\draw [decorate, decoration={snake, segment length=0.5mm, amplitude=0.5mm}] (-0.5, 4) -- (0, 3);
\draw [fill=white] (-0.5, 4) circle (0.5);
\draw [fill=black] (-0.5, 4) circle (0.25);
\draw [decorate, decoration={snake, segment length=0.5mm, amplitude=0.5mm}] (-0.25, 4.25) -- (0, 3);
\draw [fill=white] (-0.25, 4.25) circle (0.5);
\draw [fill=black] (-0.25, 4.25) circle (0.25);
\end{tikzpicture} &
\includegraphics[height=8cm]{images/robot.jpg}
\end{tabular}
\end{center}
\end{frame}

\subsection{Kommunikation}
\begin{frame}{\subsecname}
TODO: Kommunikation von Julian
\end{frame}



\section{Evaluation}
\begin{frame}{}
\begin{center}
\begin{tikzpicture}
\fill[light] (0, 0) rectangle (8, 2);
\node[dark] at (4, 1) {\begin{LARGE}\secname\end{LARGE}};
\end{tikzpicture}
\end{center}
\end{frame}

\subsection{Strom}
\begin{frame}{\subsecname}
\begin{center}
\begin{tikzpicture}[scale=0.5]
\draw (0, 0) circle (0.25);
\draw (0, 4) circle (0.25);
\draw (10, 0) circle (0.25);
\draw (10, 4) circle (0.25);
\draw (0.25, 0) -- (9.75, 0);
\draw (0.25, 4) -- (9.75, 4);
\draw (3, 4) -- (3, 6) -- (7, 6) -- (7, 4);
\draw (8, 0) -- (8, 4);
\draw [fill=black] (3, 4) circle (0.1);
\draw [fill=black] (7, 4) circle (0.1);
\draw [fill=black] (8, 0) circle (0.1);
\draw [fill=black] (8, 4) circle (0.1);
\draw [fill=white] (5, 6) circle (1) node{V};
\draw [fill=white] (8, 2) circle (1) node{V};
\draw [fill=white] (4, 3.75) rectangle (6, 4.25);
\node at (-1, 2) {$\leftarrow$ Stromquelle};
\node at (11, 2) {Board $\rightarrow$};
\end{tikzpicture}
\end{center}
\end{frame}

\begin{frame}{\subsecname}
TODO: Ergebnisse
\end{frame}

\subsection{Zeit}
\begin{frame}{\subsecname}
\centering
\begin{tabular}{ |p{3cm}||p{2cm}|p{2cm}|p{2cm}|  }
 \hline
 \multicolumn{4}{|c|}{Zeitmessung (ms)} \\
 \hline
 Abschnitt      & Durchschnitt & Min & Max\\
 \hline
 Preprocessing  &          ??? & ??? & ??? \\
 Registrierung  &          ??? & ??? & ??? \\
 TSDF Update    &          ??? & ??? & ??? \\
 Map Shift      &          ??? & ??? & ??? \\
 \hline
\end{tabular}
\end{frame}

\begin{frame}{\subsecname}
\centering
\begin{tabular}{ |l||l|l|  }
 \hline
 \multicolumn{3}{|c|}{Vergleich Vitis -- Realität} \\
 \hline
 Abschnitt      & Vitis & Gemessen\\
 \hline
 Registrierung  & 0.9ms $\cdot$ 100 = 90ms & ??? \\
 TSDF Update    & 477ms & ??? \\
 \hline
\end{tabular}
\end{frame}

\begin{frame}{\subsecname}
\centering
\begin{tabular}{ |p{3cm}||p{2cm}|p{2cm}|p{2cm}|  }
 \hline
 \multicolumn{4}{|c|}{Vergleich (Durchschnitt, ms)} \\
 \hline
 Programm       & FastSense & Prototyp & Prototyp \\
 \hline
 System         &     Board &    Board &      NUC \\
 \hline
 Preprocessing  &       ??? &      ??? &      ??? \\
 Registrierung  &       ??? &      ??? &      ??? \\
 TSDF Update    &       ??? &      ??? &      ??? \\
 Map Shift      &       ??? &      ??? &      ??? \\
\hline
\end{tabular}
\end{frame}



\section{Fazit}
\begin{frame}{}
\begin{center}
\begin{tikzpicture}
\fill[light] (0, 0) rectangle (8, 2);
\node[dark] at (4, 1) {\begin{LARGE}\secname\end{LARGE}};
\end{tikzpicture}
\end{center}
\end{frame}

\subsection{Bisherige Verbesserungen}
\begin{frame}{\subsecname}
\begin{itemize}
\item{Registrierung}
\begin{itemize}
\item{Auslagerung von Point to TSDF auf Hardware}
\item{Auslagerung von Pointcloud Transformation auf Hardware}
\end{itemize}
\item{TSDF}
\end{itemize}
\end{frame}

\subsection{Verbesserungspotenzial}
\begin{frame}{\subsecname}
\begin{itemize}
\item{Registrierung}
\begin{itemize}
\item{Drift entfernen (aktuell noch leichter Drift (1cm/s) in alle 3 Richtungen)}
\item{Komplett in Hardware (Overhead ist fast dreimal so hoch wie der eigentliche Aufruf)}
\end{itemize}
\end{itemize}
\end{frame}

\subsection{Projektmanagement}
\begin{frame}{\subsecname}
\begin{textblock*}{12.7cm}(0cm,1cm)
\begin{center}
\includegraphics[width=12cm]{images/roadmap.png}
\end{center}
\end{textblock*}
\end{frame}

\begin{frame}{\subsecname}
\begin{textblock*}{12.7cm}(0cm,1cm)
\begin{center}
\includegraphics[width=12cm]{images/roadmap_new.png}
\end{center}
\end{textblock*}
\end{frame}

\section{Ausblick / MS3}
\begin{frame}{\secname}
\begin{itemize}
\item{Aufbau einer SLAM-Box mittels CAD}
\begin{itemize}
\item{Nutzung als Sensor}
\item{Einfache Portierung zwischen Drohne, Roboter, Rucksack etc.}
\item{Festes Interface, einfache Bedienung, Kapselung}
\end{itemize}
\item{Verbesserung und Optimierung des Algorithmus}
\item{Mesh-Generierung auf Basis der TSDF Werte}
\item{Loop Closing}
\item{???}
\end{itemize}
TODO: Mehr Ideen für MS3
\end{frame}

\begin{frame}{Quellen}
\printbibliography{}
\end{frame}

\end{document}
